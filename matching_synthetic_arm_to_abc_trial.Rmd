---
title: "matching_synthetic_arm_to_abc_trial"
author: "Darren S Thomas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
always_allow_html: yes
output: github_document
---
# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,      # output code chunks
    message = FALSE,  # toggle off message output 
    warning = FALSE)  # toggle off warning output

library(texPreview)
tex_opts$set(
  density = 600  # High resolution LaTeX output
)
# Include HTML images when knitting with github_document
if (isTRUE(getOption('knitr.in.progress'))) {
  tex_opts$set(
    returnType = "html"
  )
} 
```

Load packages.

```{r message=FALSE}
library(MatchIt)
library(tidymodels)
library(tidyverse)
```

Assign default ggplot theme.

```{r}
courier_bw <- theme_bw() +
  theme(text = element_text(family = "Courier"),
        legend.position = "bottom")

theme_set(courier_bw)
```

Read characteristics of abc subjects randomised to Avastin arm.

```{r}
abc.arm <- read_csv("data/abc_patient_characteristics.csv",
                    col_types = cols(
                      id = col_character())) %>% 
  mutate(cohort = "abc")
```

Read characteristics of ehr pool whom recieved Eylea.

```{r}
ehr.pool <- read_csv("data/ehr_patient_characteristics.csv") %>% 
  mutate(cohort = "ehr")
```

Union ehr and abc tables & then assign a dummy variable as being 1 if randomised to recieve Avastin and 0 if Eylea recieved.

```{r}
abc.ehr <- bind_rows(abc.arm,
                ehr.pool) %>% 
  # create avastin_dummy that is 1 if avastin recieved and 0 if eylea
  mutate(avastin = if_else(treatment == "avastin", 1, 0)) %>% 
  rename(age = age_at_baseline,
         etdrs = baseline_etdrs)
```

# logit propensity scoring

Baseline characteristics were balanced between the ABC and EHR arms on proensity scores derived from a logistic generalised linear model regressed on treatment recieved (1 if randomised to recieve Avastin/ 0 if Eylea recieved as per standard healthcare). Baseline characteristics contributing to the pronensity scores were `baseline_va`, `age_at_baseline`, `gender` (*AND POTENTIALLY MATCHED FOR OCT THICKNESS AND PED, IF AVAILABLE*).

```{r}
logit <- glm(formula = avastin ~
               etdrs +
               age + 
               gender,
               family = binomial(link = "logit"),
             data = abc.ehr)
```

```{r echo=FALSE, results="ASIS"}
equatiomatic::extract_eq(logit,
                         use_coefs = TRUE,
                         wrap = TRUE,
                         terms_per_line = 3,
                         operator_location = "start") %>% 
  equatiomatic::preview()
```

Retrive the propensity score for each observation & then plot the distributions among ABC subjections ramdomsied to recieve Avastin and potential synthetic controls. 

```{r}
augment(logit,
        data = abc.ehr,
        type.predict = "response") %>% 
  ggplot(aes(x = .fitted, fill = cohort)) +
  geom_density(alpha = 0.75, size = 0) +
  labs(subtitle = "Distribution of propensity scores",
       x = "Propensity score",
       y = "Density") +
  scale_fill_discrete(name = NULL, labels = c("ABC Avastin arm", "Potential synthetic controls"))
```

# psm with Matchit packge

```{r}
set.seed(1337)

psm <- matchit(formula = avastin ~ etdrs + age + gender,
              data = abc.ehr,
              method = "nearest", # nearest-neighbour matching
              ratio = 10, # specifies 10:1 matching
              replace = FALSE) 
```


```{r}
summary(psm)
```

```{r}
plot(psm,
     type = "jitter")
```

# paralell psm

```{r}
i <- 1

while(i <= 10){
  mutate(abc.arm, iteration = i)
  
  i <- i + 1
}
```



# Analysis 

adjust for injection_count in the analysis.