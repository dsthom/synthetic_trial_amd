---
title: "2_ipw"
author: "Darren S Thomas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
always_allow_html: yes
output: github_document
---

Script to assign inverse propensity score weight Avastin (n 65) and Eylea (n 4,472) arms .

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,      # output code chunks
    message = FALSE,  # toggle off message output 
    warning = FALSE)  # toggle off warning output

library(texPreview)
tex_opts$set(
  density = 600  # High resolution LaTeX output
)

# include HTML images when knitting with github_document
if (isTRUE(getOption('knitr.in.progress'))) {
  tex_opts$set(
    returnType = "html"
  )
} 
```

Load packages.

```{r message=FALSE}
library(tidymodels)
library(tidyverse)
```

Assign default ggplot theme.

```{r}
courier_bw <- theme_bw() +
  theme(text = element_text(family = "Courier"),
        legend.position = "bottom")

theme_set(courier_bw)
```

Setup mysql conneciton.

```{r}
kale <- DBI::dbConnect(RMySQL::MySQL(),
                        user = "admin", 
                        password = "password",
                        dbname = "NOVA6",
                        host = "127.0.0.1",
                        port = 9999)
```

# import_data

```{sql connection = kale, output.var = abc}
SELECT *
FROM abc_patient_details;
```

Assign a dummy variable as being 1 if randomised to recieve Avastin and 0 if Eylea recieved.

```{r}
abc <- abc %>% 
  # create avastin_dummy that is 1 if avastin recieved and 0 if eylea
  mutate(avastin = if_else(treatment == "avastin" | is.na(treatment), 1, 0)) %>% 
  rename(
    age = age_at_baseline,
    etdrs = baseline_etdrs)
```

# propensity_score_model

```{r}
logit <- glm(formula = avastin ~
               etdrs +
               age + 
               gender,
               family = binomial(link = "logit"),
             data = abc)
```

```{r}
# check model asusmptions
performance::check_model(logit)
```


```{r echo=FALSE, results="ASIS"}
# create figure as LaTeX formula
equatiomatic::extract_eq(logit,
                         use_coefs = TRUE,
                         wrap = TRUE,
                         terms_per_line = 3,
                         operator_location = "start") %>% 
  equatiomatic::preview()
# to do: automatic save of image to /figures OR exort as LaTeX formula.
```

```{r}
# calculate individual probability for each row
abc.augment <- augment(logit,
      data = abc,
      type.predict = "response") %>% 
mutate(avastin = factor(avastin, levels = c(1, 0))) %>% 
drop_na(treatment)
```

```{r}
# plot as density distributions
ggplot(abc.augment, aes(x = .fitted, fill = avastin)) +
geom_density(alpha = 0.75, 
             size = 0) +
labs(subtitle = "Distribution of propensity scores",
     x = "Propensity score",
     y = "Density") +
scale_fill_manual(values = c("#FF6B6B", "#63E8DF"),
                  name = NULL,
                  labels = c("ABC Avastin arm", "ABC SOC arm")) +
scale_x_continuous(breaks = seq(0, 1, 0.1),
                   limits = c(0, 1))
```

```{r}
# export above plot to /figures
ggsave(
  filename = "propensity_score_model_distributions.png",
  plot = last_plot(),
  path = "figures",
  dpi = "retina"
)
```

# coniditional_probabilities

Import eylea arm from kale.

```{sql connection = kale, output.var = eylea.arm}
SELECT patient_eye,
       gender,
       age_at_baseline AS age, 
       baseline_va AS etdrs,
       injection_count,
       days_between_injection_and_exit_va	AS drug_recency		
FROM amd_synthetic_eylea_arm_study_table
WHERE eligibility = 1;
```

```{r}
# standardise variables in Avastin & Eylea tables
avastin.arm <- abc %>% 
  filter(treatment == "avastin") %>% 
  mutate(drug_recency = NA) %>% 
  select(
    patient_eye = id,
    treatment,
    gender,
    age,
    etdrs,
    injection_count,
    drug_recency
  )

eylea.arm <- eylea.arm %>% 
  mutate(treatment = "eylea") %>% 
  select(
    patient_eye,
    treatment,
    gender,
    age,
    etdrs,
    injection_count,
    drug_recency
  )

# combine into a single tibble

target.trial <- bind_rows(avastin.arm, eylea.arm)
```

```{r}
# propensity score each eye
ps <- augment(logit,
        newdata = target.trial,
        type.predict = "response") 
```
Different columns, perhaps?


```{r}
# plot distirbutions
```


## conditional_probabilities

```{r}
abc.augment %>% 
  filter(treatment == "eylea") %>% 
  summarise(mean_pr = mean(.fitted))
```

## etdrs

## age

## gender

```{r}
abc.augment %>% 
  group_by(gender) %>% 
  summarise(mean_pr = mean(.fitted))
```

