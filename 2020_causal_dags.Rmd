---
title: "causal_dags"
author: "Darren S Thomas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
always_allow_html: yes
output: github_document
---
# Setup

Script to create causal DAGs. 

Great tutorial found [here](https://www.andrewheiss.com/blog/2020/02/25/closing-backdoors-dags/).

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,      # output code chunks
    message = FALSE,  # toggle off message output 
    warning = FALSE)  # toggle off warning output
```

```{r}
# load frequently used packages.
library(ggdag)
library(patchwork)
library(tidyverse)
```

# eylea_arm

```{r}
# create nodes and edge coordinates
dagify(
  y ~ x + Age + va + Gender + Recency + Treatments,
  x ~ Age + va + Gender,
  exposure = "x",
  outcome = "y"
) %>% 
# turn into tidy dataframe
  tidy_dagitty(
    seed = 2,
    layout = "nicely") %>%  # no immeiately clear what this argument does
  node_status() %>% 
  ggdag(ehr.dag) +
  theme_dag()
```

Or, have more control of the plotting:

```{r}
# create tibble of abbriviated node names, coordinates, and coordinates
ehr.nodes <- tribble(
  ~ name, ~ label, ~ x, ~ y,
  "treatment", "Treatment", 2, 1,
  "outcome", "Week 54 acuity", 6, 1,
  "age", "Age", 1, 2,
  "bl_va", "Week 0 acuity", 2, 2,
  "gender", "Gender", 3, 2,
  "recency", "Recency", 5, 2,
  "n_injections", "Drug load", 7, 2 
)
```

```{r}
node_labels <- ehr.nodes$label
names(node_labels) <- ehr.nodes$name
```

```{r}
# turn into dag object
tidy.ehr.dag <- dagify(
  outcome ~ treatment + age + bl_va + gender + recency + n_injections,
  treatment ~ age + bl_va + gender,
  exposure = "treatment",
  outcome = "outcome",
  coords = ehr.nodes,
  labels = node_labels
) %>% 
# turn dag object into tidy frame for plotting  
  tidy_dagitty() %>% 
# add variable with node status (i.e. whether outcome, exposure or latent)
  node_status()
```

Plot graph via `ggplot()`.

```{r}
# set colours for variable types
node_colours <- c(exposure = "#0074D9", outcome = "#FF4136")

ggplot(tidy.ehr.dag, 
       aes(
         x = x, 
         y = y,
         xend = xend,
         yend = yend)) +
  geom_dag_edges() +
  geom_dag_point(aes(colour = status)) +
  geom_dag_label_repel(
    aes(
      label = label,
      fill = status), 
    seed = 1000, # change seed
    color = "white", 
    fontface = "bold") +
  scale_color_manual(
    values = node_colours, 
    na.value = "grey20") +
  scale_fill_manual(
    values = node_colours, 
    na.value = "grey20") +
  guides(
    colour = FALSE, 
    fill = FALSE) +
  theme_dag() +
  labs(title = "Eylea arm")
```

# avastin_arm

As before, but without pre-randomisaiton covariates (exchangebaility assumed owing to randomisation).

```{r}
abc.nodes <- tribble(
  ~ name, ~ label, ~ x, ~ y,
  "treatment", "Treatment", 2, 1,
  "outcome", "Week 54 acuity", 6, 1,
  "recency", "Recency", 5, 2,
  "n_injections", "Treatments", 7, 2
)
```

```{r}
node_labels <- abc.nodes$label
names(node_labels) <- abc.nodes$name
```

```{r}
# turn into dag object
tidy.abc.dag <- dagify(
  outcome ~ treatment + recency + n_injections,
  exposure = "treatment",
  outcome = "outcome",
  coords = abc.nodes,
  labels = node_labels
) %>% 
# turn dag object into tidy frame for plotting  
  tidy_dagitty() %>% 
# add variable with node status (i.e. whether outcome, exposure or latent)
  node_status()
```

```{r}
# set colours for variable types
node_colours <- c(exposure = "#0074D9", outcome = "#FF4136")

ggplot(tidy.abc.dag, 
       aes(
         x = x, 
         y = y,
         xend = xend,
         yend = yend)) +
  geom_dag_edges() +
  geom_dag_point(aes(colour = status)) +
  geom_dag_label_repel(
    aes(
      label = label,
      fill = status), 
    seed = 1000, # change seed
    color = "white", 
    fontface = "bold") +
  scale_color_manual(
    values = node_colours, 
    na.value = "grey20") +
  scale_fill_manual(
    values = node_colours, 
    na.value = "grey20") +
  guides(
    colour = FALSE, 
    fill = FALSE) +
  theme_dag() +
  labs(title = "Avastin arm")
```

# To do:

* Use built in functions to d-separation/ identify variables that need conditioning on (see https://www.andrewheiss.com/blog/2020/02/25/closing-backdoors-dags/)
* Use LaTeX.

* Add box around baseline variables you match for.