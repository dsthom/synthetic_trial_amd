---
title: "abc_to_kale"
author: "Darren S Thomas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
always_allow_html: yes
output: github_document
---

# setup

Throwaway script to transform original .csv files & upload to kale (replaces `0_read_abc_data.R`)

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,      # output code chunks
    message = FALSE,  # toggle off message output 
    warning = FALSE)  # toggle off warning output
```

Load frequently used packages.

```{r}
library(tidyverse)
```

Connect to kale.

```{r}
kale <- DBI::dbConnect(RMySQL::MySQL(),
                        user = "admin", 
                        password = "password",
                        dbname = "NOVA6",
                        host = "127.0.0.1",
                        port = 9999)
```

# visual_acuity

Transform .csv to a format more familiar.

```{r} 
abc.acuity <- read_csv("../data/abc_trial_acuity.csv",
                col_types = cols(
                  studynumber = col_integer(),
                  lost = col_factor(),
                  arm = col_factor(),
                  treatment = col_factor(),
                  trt = col_factor()
                ))

abc.acuity  <- abc.acuity  %>% 
  # shorten variable names that start_with "vast"
  rename_at(vars(starts_with("vast")), funs(str_replace(., "vast", ""))) %>% 
  # convert treatment strings to lowercase 
  mutate(treatment = tolower(treatment)) %>% 
  # convert dataframe to long-form
  pivot_longer(cols = 2:12,
               names_to = "week",
               values_to = "etdrs") %>% 
  # convert week to numeric
  mutate(week = as.numeric(week)) %>% 
  # arrange by studynumber & then week
  arrange(studynumber, week) %>% 
  # rename studynumber to snake_case 
  rename(id = studynumber) %>% 
  # filter for avastin arm
  filter(treatment == "avastin") %>%
  # select columns
  select(id, treatment, week, etdrs)
```

Note that weeks that have no visual acuity measurement do not have a row. Create a base tibble with all permutations

```{r}
bed <- crossing(
  id = abc.acuity$id,
  week = seq(0, 54, by = 6))
```

Populate visual acuity. Thus, weeks without a visual measurement are now speifiec as NA. 

```{r}
bed <- bed %>% 
  left_join(abc.acuity,
            by = c("id", "week")) %>% 
  # reorder columns
  select(
    id,
    treatment,
    week,
    etdrs
  )
```

Export to kale.

```{r}
DBI::dbWriteTable(
  conn = kale,
  name = "abc_va_longform",
  value = bed,
  overwrite = TRUE
)
```

# patient_charactieristics

Transform .csv to a format more familiar.

```{r}
abc.patient.details <- read_csv("../data/abc_trial_age.csv",
                    col_types = cols(
                      studyNumber = col_integer()
                    ))
```

43 is mislabelled and was randomised to Avastin arm (see `abc.acuity` for confirmation).

```{r}
# label subject 43
abc.patient.details$treatment[abc.patient.details$studyNumber == 43] <- "Avastin"
```

Grab the baseline visual acuity from `abc.acuity`.

```{r}
baseline.acuity <- abc.acuity %>% 
  filter(week == 0) %>% 
  rename(study_number = id)
```

```{r}
abc.patient.details <- abc.patient.details %>% 
  # rename variables to lowercase
  rename(study_number = studyNumber,
         age_at_baseline = Age,
         injection_count = avastintrt) %>% 
  # convert Gender strings to M & F in parity with ehr data
  mutate(gender = case_when(gender == "Male" ~ "M",
                            gender == "Female" ~ "F")) %>% 
  # convert treatment strings to lowercase 
  mutate(treatment = tolower(treatment)) %>% 
  # append baseline va
  left_join(select(baseline.acuity, 
                   study_number, 
                   baseline_etdrs = etdrs),
            by = "study_number",
            keep = FALSE) %>% 
  # transform study_number to character
  mutate(study_number = as.character(study_number)) %>% 
  # keep only variables relevant to PS
  select(
    id = study_number,
    treatment,
    injection_count,
    gender,
    age_at_baseline,
    baseline_etdrs) %>% 
  # filter for Avastin arm
  filter(treatment == "avastin")
```

Export to kale.

```{r}
DBI::dbWriteTable(
  conn = kale,
  name = "abc_patient_details",
  value = abc.patient.details,
  overwrite = TRUE
)
```

SCRIPT END.